angular.module("ui.mask",[]).value("uiMaskConfig",{maskDefinitions:{9:/\d/,A:/[a-zA-Z]/,"*":/[a-zA-Z0-9]/}}).directive("uiMask",["uiMaskConfig","$parse",function(a,b){return{priority:100,require:"ngModel",restrict:"A",compile:function(){var c=a;return function(a,d,e,f){function v(a){return angular.isDefined(a)?(K(a),g?(C(),D(),!0):B()):B()}function w(a){angular.isDefined(a)&&(k=a,g&&O())}function x(a){return g?(n=G(a||""),p=F(n),f.$setValidity("mask",p),p&&n.length?H(n):void 0):a}function y(a){return g?(n=G(a||""),p=F(n),f.$viewValue=n.length?H(n):"",f.$setValidity("mask",p),""===n&&e.required&&f.$setValidity("required",!1),p?n:void 0):a}function B(){return g=!1,E(),angular.isDefined(q)?d.attr("maxlength",q):d.removeAttr("maxlength"),d.val(f.$modelValue),f.$viewValue=f.$modelValue,!1}function C(){n=s=G(f.$modelValue||""),o=r=H(n),p=F(n);var a=p&&n.length?o:"";e.maxlength&&d.attr("maxlength",2*i[i.length-1]),d.val(a),f.$viewValue=a}function D(){h||(d.bind("blur",L),d.bind("mousedown mouseup",M),d.bind("input keyup click focus",O),h=!0)}function E(){h&&(d.unbind("blur",L),d.unbind("mousedown",M),d.unbind("mouseup",M),d.unbind("input",O),d.unbind("keyup",O),d.unbind("click",O),d.unbind("focus",O),h=!1)}function F(a){return a.length?a.length>=m:!0}function G(a){var b="",c=j.slice();return a=a.toString(),angular.forEach(l,function(b){a=a.replace(b,"")}),angular.forEach(a.split(""),function(a){c.length&&c[0].test(a)&&(b+=a,c.shift())}),b}function H(a){var b="",c=i.slice();return angular.forEach(k.split(""),function(d,e){a.length&&e===c[0]?(b+=a.charAt(0)||"_",a=a.substr(1),c.shift()):b+=d}),b}function I(a){var b=e.uiMaskFormat;return"undefined"!=typeof b&&b[a]?b[a]:"_"}function J(){return k.replace(/[_]+/g,"_").replace(/([^_]+)([a-zA-Z0-9])([^_])/g,"$1$2_$3").split("_")}function K(a){var b=0;if(i=[],j=[],k="","string"==typeof a){m=0;var c=!1,d=a.split("");angular.forEach(d,function(a,d){z.maskDefinitions[a]?(i.push(b),k+=I(d),j.push(z.maskDefinitions[a]),b++,c||m++):"?"===a?c=!0:(k+=a,b++)})}i.push(i.slice().pop()+1),l=J(),g=i.length>1?!0:!1}function L(){t=0,u=0,p&&0!==n.length||(o="",d.val(""),a.$apply(function(){f.$setViewValue("")}))}function M(a){"mousedown"===a.type?d.bind("mouseout",N):d.unbind("mouseout",N)}function N(){u=S(this),d.unbind("mouseout",N)}function O(b){b=b||{};var c=b.which,e=b.type;if(16!==c&&91!==c){var j,g=d.val(),h=r,k=G(g),l=s,m=!1,n=Q(this)||0,o=t||0,p=n-o,q=i[0],v=i[k.length]||i.slice().shift(),w=u||0,x=S(this)>0,y=w>0,z=g.length>h.length||w&&g.length>h.length-w,A=g.length<h.length||w&&g.length===h.length-w,B=c>=37&&40>=c&&b.shiftKey,C=37===c,D=8===c||"keyup"!==e&&A&&-1===p,E=46===c||"keyup"!==e&&A&&0===p&&!y,F=(C||D||"click"===e)&&n>q;if(u=S(this),!B&&(!x||"click"!==e&&"keyup"!==e)){if("input"===e&&A&&!y&&k===l){for(;D&&n>q&&!P(n);)n--;for(;E&&v>n&&-1===i.indexOf(n);)n++;var I=i.indexOf(n);k=k.substring(0,I)+k.substring(I+1),m=!0}for(j=H(k),r=j,s=k,d.val(j),m&&a.$apply(function(){f.$setViewValue(k)}),z&&q>=n&&(n=q+1),F&&n--,n=n>v?v:q>n?q:n;!P(n)&&n>q&&v>n;)n+=F?-1:1;(F&&v>n||z&&!P(o))&&n++,t=n,R(this,n)}}}function P(a){return i.indexOf(a)>-1}function Q(a){if(!a)return 0;if(void 0!==a.selectionStart)return a.selectionStart;if(document.selection){a.focus();var b=document.selection.createRange();return b.moveStart("character",a.value?-a.value.length:0),b.text.length}return 0}function R(a,b){if(!a)return 0;if(0!==a.offsetWidth&&0!==a.offsetHeight)if(a.setSelectionRange)a.focus(),a.setSelectionRange(b,b);else if(a.createTextRange){var c=a.createTextRange();c.collapse(!0),c.moveEnd("character",b),c.moveStart("character",b),c.select()}}function S(a){return a?void 0!==a.selectionStart?a.selectionEnd-a.selectionStart:document.selection?document.selection.createRange().text.length:0:0}var i,j,k,l,m,n,o,p,r,s,t,u,g=!1,h=!1,q=e.maxlength,z={};e.uiOptions?(z=a.$eval("["+e.uiOptions+"]"),angular.isObject(z[0])&&(z=function(a,b){for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b[c]?angular.extend(b[c],a[c]):b[c]=angular.copy(a[c]));return b}(c,z[0]))):z=c,e.$observe("uiMask",v),e.$observe("uiMaskFormat",w);var A=!1;e.$observe("modelViewValue",function(a){"true"===a&&(A=!0)}),a.$watch(e.ngModel,function(c){if(A&&c){var d=b(e.ngModel);d.assign(a,f.$viewValue)}}),f.$formatters.push(x),f.$parsers.push(y),d.bind("mousedown mouseup",M),Array.prototype.indexOf||(Array.prototype.indexOf=function(a){if(null===this)throw new TypeError;var b=Object(this),c=b.length>>>0;if(0===c)return-1;var d=0;if(arguments.length>1&&(d=Number(arguments[1]),d!==d?d=0:0!==d&&1/0!==d&&d!==-1/0&&(d=(d>0||-1)*Math.floor(Math.abs(d)))),d>=c)return-1;for(var e=d>=0?d:Math.max(c-Math.abs(d),0);c>e;e++)if(e in b&&b[e]===a)return e;return-1})}}}}]);